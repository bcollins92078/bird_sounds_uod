# uod_cvae README

## Dependencies
These scripts require the following Python libraries:

-   `os`
-   `sys`
-   `glob`
-   `pathlib`
-   `pandas`
-   `numpy`
-   `argparse`
- 	`time`
-	`datetime`
-	`warnings`
-	`librosa`
-	`tensorflow`
-	`scipy.cluster.hierarchy` (specifically `linkage`, `cophenet`, `fcluster`)
- 	`scipy.spatial.hierarchy` (specifically `pdist`, `squareform`)
-	`sklearn.metrics.cluster` (specifically `homogeneity_score`)
-	`sklearn.manifold` (specifically `TSNE`)

## cvae_clean.py

### Description

Python script automates the per-species data cleaning using a convolutional variational autoencoder (CVAE) as follows:
* Dimensionality reduction: CVAE is trained on preprocessed spectrogram clips from bird sound recordings
* Hierarchical agglomerative clustering (HAC) is applied to the CVAE latent space representation of the clips to produce n_clusters
* Discard candidates are determined at the cluster level with smallest clusters farthest away from one of the biggest clusters recommended for discard first and proceeding to larger clusters until the specified max discard percentage is reached
* The preceding process steps are repeated a specified number of times and each time the resulting model parameters, latent space encodings, cluster assignments and discard decisions are saved
* Final per clip discard decisions are made based on majority voting and these decisions are saved in the <species>_bvp.csv file to indicate which BVPs to include in downstream processing (e.g., classifier training).


### Command Line Inputs

-   `species`: (Positional) The bird species to process BVPs for.
-   `-z, --z-dim`: The latent variable dimension (default: 2).
-   `-c, --num-clusters`: The number of HAC clusters (default: 50).
-   `--iterations`: The number of models to train and evaluate (default: 11).
-   `-e, --epochs`: The number of epochs to train each model (default: 80).
-   `--batch-size`: The training batch size (default: 32).
-   `--max-discards`: The maximum fraction of BVPs to discard (default: 0.1).
-   `-l, --learning-rate`: The learning rate (default: 0.0001).
-   `-b, --num-big`: The minimum number of big clusters (default: 2).
-   `-s, --song-call`: Specifies if the species has distinct song and call vocalizations (1 for yes, 0 for no; default: 1).

### Outputs

All output files are saved within the `<species>/analysis/artifacts/` directory, with filenames containing a unique timestamp and run parameters (`iter_label`).

-   **metrics\_{iter\_label}.csv**: A CSV file containing per-cluster metrics for each iteration, including cluster size, number of songs/calls, percentage of songs/calls, distance to the nearest large cluster, and a discard recommendation.
-   **encoding\_clustered\_{iter\_label}.csv**: A CSV file with the latent space encoding and cluster assignment for each input sample for a given iteration.
-   **discard\_{iter\_label}.csv**: A CSV file containing the aggregated discard recommendations from all iterations. Each column corresponds to an iteration, and values indicate whether a sample was recommended for discard in that run.
-   **summary\_{iter\_label}.csv**: A CSV file summarizing the results of all iterations, including validation loss, cophenetic correlation, total discards, number of large clusters, and cluster purity metrics.

Additionally, the script saves the following model files in the `<species>/analysis/models/` directory:

-   **init\_weights**: The initial model weights, saved before training begins, used to initialize the model for each iteration.
-   **cvae\_a2\_z{latent\_dim}\_{timestamp}**: The trained model weights for each iteration.

## cvae_post.py

### Description

This script post-processes the output files generated by `cvae_clean.py`. It aggregates discard recommendations across multiple CVAE model runs to produce a final set of recommendations. The script identifies the most recent summary and discard files, filters out model iterations with abnormally high validation loss, and then tallies the remaining per-clip discard votes. It applies a majority vote to determine a final discard decision and also calculates an adjusted decision to meet a specified target discard fraction. The results (tallies and final decisions) are added as new columns to the discard file that was processed.

### Command Line Inputs

-   `species`: (Positional) The bird species to post-process CVAE outputs for.
-   `-l, --hi-loss-thresh`: The fraction above the median validation loss at which a model iteration is excluded (default: 0.2).
-   `-d, --max-discard-frac`: The maximum fraction of samples to discard (default: 0.1).
-   `-t, --target-discard-frac`: The target fraction of samples to discard (default: 0.05).
-   `-z, --z-dim`: The number of latent dimensions used in the CVAE model (default: 10).

### Outputs

This script does not create new files but modifies the most recent `discard_cvae_*.csv` file located in the `<species>/analysis/artifacts/` directory. The script adds the following columns to this file:

-   `tally`: The total count of discard recommendations a sample received from all selected model iterations.
-   `maj`: The final discard recommendation (True/False) based on a majority vote threshold.
-   `adj`: An adjusted discard recommendation (True/False) where the vote threshold is modified to more closely match the target discard fraction.